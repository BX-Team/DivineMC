From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: NONPLAYT <76615486+NONPLAYT@users.noreply.github.com>
Date: Sun, 6 Jul 2025 02:08:04 +0300
Subject: [PATCH] Fix MC-258859

Issue on Mojira: https://bugs.mojang.com/browse/MC/issues/MC-258859

diff --git a/net/minecraft/world/level/levelgen/SurfaceRules.java b/net/minecraft/world/level/levelgen/SurfaceRules.java
index 0948c8db90605a15a043b5c5bc74edecd7f9db1b..32757c6847cf77862a2f1b38cc53e7166e6be492 100644
--- a/net/minecraft/world/level/levelgen/SurfaceRules.java
+++ b/net/minecraft/world/level/levelgen/SurfaceRules.java
@@ -397,6 +397,22 @@ public class SurfaceRules {
 
             @Override
             protected boolean compute() {
+                // DivineMC start - Fix MC-258859
+                if (org.bxteam.divinemc.config.DivineConfig.FixesCategory.slopesVisualFix) {
+                    int x = this.context.blockX & 15;
+                    int z = this.context.blockZ & 15;
+                    ChunkAccess chunk = this.context.chunk;
+                    int south = chunk.getHeight(Heightmap.Types.WORLD_SURFACE_WG, x, Math.max(z - 1, 0));
+                    int north = chunk.getHeight(Heightmap.Types.WORLD_SURFACE_WG, x, Math.min(z + 1, 15));
+                    if (Math.abs(north - south) >= 4) {
+                        return true;
+                    } else {
+                        int west = chunk.getHeight(Heightmap.Types.WORLD_SURFACE_WG, Math.max(x - 1, 0), z);
+                        int east = chunk.getHeight(Heightmap.Types.WORLD_SURFACE_WG, Math.min(x + 1, 15), z);
+                        return Math.abs(west - east) >= 4;
+                    }
+                }
+                // DivineMC end - Fix MC-258859
                 int i = this.context.blockX & 15;
                 int i1 = this.context.blockZ & 15;
                 int max = Math.max(i1 - 1, 0);
